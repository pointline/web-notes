(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{282:function(s,t,a){s.exports=a.p+"assets/register-runner.53aff290.png"},283:function(s,t,a){s.exports=a.p+"assets/variables.6a108ba2.png"},418:function(s,t,a){"use strict";a.r(t);var n=a(17),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"gitlab-gitlab-runner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-gitlab-runner"}},[s._v("#")]),s._v(" Gitlab + Gitlab Runner")]),s._v(" "),n("h2",{attrs:{id:"安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),n("h2",{attrs:{id:"注册"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注册"}},[s._v("#")]),s._v(" 注册")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("gitlab-runner register\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("之后是 QA 式操作，按照提示内容输入，可参考"),n("a",{attrs:{href:"https://docs.gitlab.com/runner/register/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官网操作"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("或者直接通过命令行设置参数，比较方便")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("gitlab-runner register -n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --url http://gitlab.example.com:8929/ "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --registration-token dFaZ-PdbPX_xBybUkjq4 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --executor docker "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --description "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Runner Description"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --tag-list "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --docker-image "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node:10.16.3-alpine"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --docker-volumes /var/run/docker.sock:/var/run/docker.sock "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --docker-extra-hosts "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gitlab.example.com:172.21.0.3"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   --docker-network-mode gitlab_gitlab-network\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("注意：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("url")]),s._v("：gitlab 地址")]),s._v(" "),n("li",[n("code",[s._v("registration-token")]),s._v("：在 gitlab 项目中"),n("code",[s._v("settings->CI/CD->Runners->Set up a specific Runner manually->token")])]),s._v(" "),n("li",[n("code",[s._v("executor")]),s._v("：执行器选择"),n("code",[s._v("docker")]),s._v("或者"),n("code",[s._v("shell")])]),s._v(" "),n("li",[n("code",[s._v("description")]),s._v("：当前执行器描述")]),s._v(" "),n("li",[n("code",[s._v("tag-list")]),s._v("：tags")]),s._v(" "),n("li",[n("code",[s._v("docker-image")]),s._v("：如果"),n("code",[s._v("executor")]),s._v("选择"),n("code",[s._v("docker")]),s._v("，设置"),n("code",[s._v("image")])]),s._v(" "),n("li",[n("code",[s._v("docker-volumes")]),s._v("：如果"),n("code",[s._v("executor")]),s._v("选择"),n("code",[s._v("docker")]),s._v("，把"),n("code",[s._v("gitlab-runner")]),s._v("机器上的"),n("code",[s._v("docker")]),s._v("功能链接进新启动的"),n("code",[s._v("container")])]),s._v(" "),n("li",[n("code",[s._v("docker-extra-hosts")]),s._v("：写入额外的"),n("code",[s._v("host")]),s._v("内容")]),s._v(" "),n("li",[n("code",[s._v("docker-network-mode")]),s._v("设置新启动"),n("code",[s._v("docker container")]),s._v("的"),n("code",[s._v("network")]),s._v("，方便与其他容器链接")])]),s._v(" "),n("p",[s._v("注册成功后，看到下图就说明配置成功了")]),s._v(" "),n("p",[n("img",{attrs:{src:a(282),alt:"register runner"}})]),s._v(" "),n("h2",{attrs:{id:"ssh-免密登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ssh-免密登录"}},[s._v("#")]),s._v(" ssh 免密登录")]),s._v(" "),n("h3",{attrs:{id:"为什么需要免密码登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要免密码登录"}},[s._v("#")]),s._v(" 为什么需要免密码登录")]),s._v(" "),n("ul",[n("li",[s._v("构建产出的 build 文件要传输到目标服务器（测试机/生成机），要么基于 http 网络协议、要么基于 ssh 协议（或其他文件传输协议？）")]),s._v(" "),n("li",[s._v("基于 http 需要写文件接收接口，这里直接使用基于 ssh 传输文件的 rsync，简单、安全！")]),s._v(" "),n("li",[s._v("runner 内定义的一系列 script 是在一个 docker 容器内执行的，无法人工干预，那么登录服务器就要做成免密。")])]),s._v(" "),n("h3",{attrs:{id:"生成一对公私钥"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#生成一对公私钥"}},[s._v("#")]),s._v(" 生成一对公私钥")]),s._v(" "),n("p",[s._v("在 runner 机器上执行，使用 rsa 作为非对称加密方式：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("ssh-keygen -t rsa -C "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("whoami")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("@"),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("hostname")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("-"),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" -I"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("一路 enter 就好了，如果你非要加个 password，对不起，没救了！")])]),s._v(" "),n("h3",{attrs:{id:"免密码登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#免密码登录"}},[s._v("#")]),s._v(" 免密码登录")]),s._v(" "),n("p",[s._v("免密登录的精髓就是：把本机的公钥存储到目标服务器的 authorized_keys 文件内（该文件服务器上不存在可以直接创建。）")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("ssh-copy-id -i ~/.ssh/id_rsa.pub username@ip\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这时可以到远程服务器下 username/.ssh/authorized_keys 查看该文件")]),s._v(" "),n("blockquote",[n("p",[s._v("如果你的端口不是默认的 22 端口，则加上端口号 -p PORT。")])]),s._v(" "),n("h3",{attrs:{id:"验证登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证登录"}},[s._v("#")]),s._v(" 验证登录")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" username@ip\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("如果你的端口不是默认的 22 端口，则加上端口号 -p PORT。")])]),s._v(" "),n("p",[s._v("不出意外，你应该可以直接登录服务器了。")]),s._v(" "),n("h2",{attrs:{id:"测试-rsync-传输文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试-rsync-传输文件"}},[s._v("#")]),s._v(" 测试 rsync 传输文件")]),s._v(" "),n("p",[s._v("在 runner 机器上新建 index.html，传输到远程服务器指定路径")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rsync")]),s._v(" -rav --delete index.html username@ip:username/site/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("注意：可能会遇到权限问题，所以确保远程服务器路径具有当前 username 权限")])]),s._v(" "),n("h2",{attrs:{id:"gitlab-仓库配置变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-仓库配置变量"}},[s._v("#")]),s._v(" gitlab 仓库配置变量")]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("gitlab仓库->settings->CI/CD->Variables")]),s._v("设置几个变量，下面"),n("code",[s._v(".gitlab.yml")]),s._v("会用到。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(283),alt:"variables"}})]),s._v(" "),n("ul",[n("li",[n("code",[s._v("SSH_PRIVATE_KEY")]),s._v("：把本机（runner 所在机器）生成的私钥复制到新容器内")]),s._v(" "),n("li",[n("code",[s._v("USER")]),s._v("：主机用户名")]),s._v(" "),n("li",[n("code",[s._v("HOSTS")]),s._v("：远程主机 IP")]),s._v(" "),n("li",[n("code",[s._v("SOURCE_DIR")]),s._v("：需要复制的目录（当前 git 目录作相对路径）")]),s._v(" "),n("li",[n("code",[s._v("TARGET_DIR")]),s._v("：远程主机目录位置")])]),s._v(" "),n("h2",{attrs:{id:"gitlab-runner-配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner-配置"}},[s._v("#")]),s._v(" gitlab runner 配置")]),s._v(" "),n("p",[s._v("先项目根目录新建"),n("code",[s._v(".gitlab.yml")]),s._v("文件，写入以下内容")]),s._v(" "),n("div",{staticClass:"language-yml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("default")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" whoami\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" pwd\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo $CI_PROJECT_DIR\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cache")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node_modules\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" package"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("lock.json\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" install_dep\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" test\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" build\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" deploy\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("install_dep_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install_dep\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm config set registry https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//registry.npm.taobao.org\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm install "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("progress=false\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("test_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'Running Test Script'\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm run test\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'End Test Script'\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" build\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("artifacts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("expire_in")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1 week\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" build\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'Running Build Script'\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm run build\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'End Build Script'\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy_job")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prod_deploy\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("url")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//github.com/\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dependencies")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" build_job\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'Set Repositories'\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//mirrors.aliyun.com/alpine/v3.9/main' "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" /etc/apk/repositories\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'https"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//mirrors.aliyun.com/alpine/v3.9/community' "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" /etc/apk/repositories\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'End Repositories'\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" apk add "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("no"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cache rsync openssh\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p ~/.ssh\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' echo "$SSH_PRIVATE_KEY" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" ~/.ssh/id_rsa\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" chmod 600 ~/.ssh/id_rsa\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('e "Host '),n("span",{pre:!0,attrs:{class:"token important"}},[s._v("*\\n\\tStrictHostKeyChecking")]),s._v(' no\\n\\n" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" ~/.ssh/config\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'Running Deploy Script'\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" rsync "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rav "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("delete $SOURCE_DIR $USER@$HOSTS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$TARGET_DIR\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" echo 'End Deploy Script'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br")])]),n("p",[s._v("其中"),n("code",[s._v("$SSH_PRIVATE_KEY")]),s._v("，"),n("code",[s._v("$SOURCE_DIR")]),s._v("，"),n("code",[s._v("$USER")]),s._v("，"),n("code",[s._v("$HOSTS")]),s._v("，"),n("code",[s._v("$TARGET_DIR")]),s._v("都是上面配置的变量，"),n("code",[s._v("$CI_PROJECT_DIR")]),s._v("是"),n("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/variables/predefined_variables.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("gitlab 内置变量"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("配置说明：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("stages")]),s._v("定义总共三个阶段"),n("code",[s._v("test")]),s._v("，"),n("code",[s._v("build")]),s._v("，"),n("code",[s._v("deploy")]),s._v("。")]),s._v(" "),n("li",[n("code",[s._v("cache")]),s._v("设置缓存文件，这里缓存 node_modules 依赖包，提高 job 构建效率，定义在全局对所有 job 都生效。")]),s._v(" "),n("li",[n("code",[s._v("artifacts")]),s._v("定义编译生成的 build 文件缓存到 gitlab 服务器，并提供下载或者各个 job 之间共享。")]),s._v(" "),n("li",[n("code",[s._v("dependencies")]),s._v("依赖的 job。")]),s._v(" "),n("li",[n("code",[s._v("before_script")]),s._v("定义的脚本在 script 之前执行。")])])])}),[],!1,null,null,null);t.default=e.exports}}]);